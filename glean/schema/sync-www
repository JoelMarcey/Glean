#!/bin/bash
set -euo pipefail

SYNC=(
  'buck.json'
  'builtin.json'
  'code-cxx.json'
  'cxx1.json'
  'glean-test.json'
  'hack.json'
  'pp1.json'
  'python.json'
  'src.json'
  'testinfra.json'
)

WWWDIR="$HOME/www"
THIS_FILE="$(readlink -f "$0")"
FBCODEDIR="${THIS_FILE%%fbcode/*}fbcode"

SRC="$FBCODEDIR/glean/schema/hackjson"
DEST="$WWWDIR/flib/intern/glean/schema/"

if [ ! -d "$DEST" ]; then
  echo "Folder not found $WWWDIR/flib/intern/glean/schema"
  echo ""
  echo "This script assumes you have a www checkout in ~/www"
  echo "Please do: fbclone www"
  exit 1
fi

buck run //glean/schema/gen:gen-schema -- \
     --dir glean/schema/source \
     --hackjson "$SRC"

if [ ! -d "$SRC" ]; then
  echo "Something went wrong: didn't find schema at $SRC"
  exit 1
fi

# Check for glean command
glean --help >/dev/null || \
  ( echo -e "\nglean: command not found"
    echo -e "You may need to run 'sudo feature install glean_tools' to install glean"
    exit 1
  )

cd "$WWWDIR"
echo ">>>>>>> Saving uncommitted changes in $WWWDIR..."
hg commit -A -R "$WWWDIR" -m "Uncommitted changes" || true
echo ">>>>>>> Pulling and updating $WWWDIR..."
hg pull && hg up stable

echo ">>>>>>> Copying from $SRC to $DEST"
include_opts=()
for item in "${SYNC[@]}"; do
    include_opts+=( "--include=$item" )
done
rsync -r --delete-excluded "${include_opts[@]}" --exclude='*' "$SRC/" "$DEST"

echo ">>>>>>> Regenerating Hack using meerkat"
(cd "$WWWDIR"; meerkat)

echo ">>>>>>> Typechecking $WWWDIR..."
hh "$WWWDIR"

set +e

read -r -d '' MSG <<- EOF
[glean] Sync schema from fbcode

Summary:
Diff generated by fbcode/glean/schema/sync-www

Test plan:
hh

Reviewers: glean
EOF
set -e

echo ">>>>>>> Committing changes..."
hg commit -A -R "$WWWDIR" -m "$MSG"

# echo ">>>>>>> Creating a diff..."
# DIFF=$(jf submit | grep -E -o 'D[0-9]+')

# echo "${DIFF} created; please get it reviewed and landed now."
